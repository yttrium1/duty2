<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Calendar Selection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #b0c4de;
    }
    .date:hover {
      cursor: pointer;
      background-color: #fbd38d;
    }
    .calendar-day, .calendar-day-sun, .calendar-day-sat {
      font-weight: bold;
      text-align: center;
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .calendar-day-sun { color: red; }
    .calendar-day-sat { color: blue; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    #generate-url {
      display: inline-block;
      background-color: #7B68EE;
      color: white;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 9999px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-screen-md mx-auto py-10">
    <div class="text-right mb-4">
      <span class="text-lg font-semibold">内科当直希望</span>
    </div>

    <div class="mb-8">
      <span class="step-button">STEP 1</span>
      <select id="name-select" class="mt-2 p-2 border border-gray-300 rounded w-full">
        <option value="">回答者の名前を選択してください(敬称略）</option>
        <option value="西中川">西中川</option>
        <option value="大場">大場</option>
        <option value="乾山">乾山</option>
        <option value="荻野">荻野</option>
        <option value="高橋（伸）">高橋（伸）</option>
        <option value="渡辺（浩）">渡辺（浩）</option>
        <option value="折原">折原</option>
        <option value="池上">池上</option>
        <option value="中島">中島</option>
        <option value="河野">河野</option>
        <option value="松村">松村</option>
        <option value="伊藤">伊藤</option>
        <option value="堂脇">堂脇</option>
        <option value="古賀">古賀</option>
        <option value="吉玉">吉玉</option>
        <option value="浅原">浅原</option>
        <option value="高亀">高亀</option>
        <option value="中村">中村</option>
        <option value="久次米">久次米</option>
        <option value="その他">その他</option>
      </select>
      <input id="other-name-input" type="text" placeholder="名前を入力" class="mt-2 p-2 border border-gray-300 rounded w-full" style="display:none;">
    </div>

    <!-- STEP 2, STEP 3, and STEP 4 placeholders for additional form elements -->

    <div>
      <button id="generate-url" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full">送信する</button>
    </div>
  </div>

  <!-- モーダル -->
  <div id="dateModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>日付の選択肢</h3>
      <button class="option" data-option="当直のみ">当直のみ</button>
      <button class="option" data-option="日直のみ">日直のみ</button>
      <button class="option" data-option="両方">両方</button>
    </div>
  </div>

  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
      emailjs.init("user_ID"); // あなたのEmailJSのユーザーIDに置き換えてください
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // カレンダー表示、モーダル処理、EmailJS送信処理をここに組み込む

      let now = new Date(); // 現在の日付と時刻を取得
      let currentMonth = new Date(now.getFullYear(), now.getMonth(), 1); // 現在の月の最初の日を取得
      // 現在の日が1から10の間かどうかをチェック
      if (now.getDate() >= 1 && now.getDate() <= 10) {
        // 1-10日の場合、1ヶ月後のカレンダーを表示
        currentMonth.setMonth(currentMonth.getMonth() + 1);
      } else {
        // それ以外の場合、2ヶ月後のカレンダーを表示
        currentMonth.setMonth(currentMonth.getMonth() + 2);
      }

      const monthTitle = document.querySelectorAll('.month-title');
      const calendarGrids = document.querySelectorAll('.calendar-grid');

      function updateCalendar(month) {
        monthTitle.forEach(title => {
          title.textContent = `${month.getFullYear()}年 ${month.getMonth() + 1}月`;
        });

        calendarGrids.forEach(grid => {
          grid.innerHTML = ''; // Clear the calendar grid

          // Get the first day of the month
          const firstDay = new Date(month.getFullYear(), month.getMonth(), 1).getDay();
          // Get the number of days in the month
          const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();

          // Add day labels
          const daysOfWeek = ['日', '月', '火', '水', '木', '金', '土'];
          daysOfWeek.forEach((day, index) => {
            let dayClass = 'calendar-day';
            if (index === 0) dayClass += ' calendar-day-sun';
            if (index === 6) dayClass += ' calendar-day-sat';
            grid.innerHTML += `<div class="${dayClass}">${day}</div>`;
          });

          // Add empty cells before the first day of the month
          for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += '<div></div>';
          }

          // Add day cells to the calendar
          for (let i = 1; i <= daysInMonth; i++) {
            grid.innerHTML += `<div class="date" data-date="${month.getFullYear()}-${month.getMonth()+1}-${i}">${i}</div>`;
          }

          // Re-add event listeners to new date elements
          grid.querySelectorAll('.date').forEach(date => {
            date.addEventListener('click', function() {
              this.classList.toggle('bg-yellow-300');
              // Show modal on date click
              const modal = document.getElementById('dateModal');
              modal.style.display = 'block';

              // Handle modal option click
              document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                  const selectedOption = this.getAttribute('data-option');
                  const selectedDate = date.getAttribute('data-date');
                  console.log(`選択: ${selectedOption} for date ${selectedDate}`);
                  modal.style.display = 'none';
                });
              });
            });
          });
        });
      }

      updateCalendar(currentMonth);

      document.querySelectorAll('.prev-month').forEach(button => {
        button.addEventListener('click', function() {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
          updateCalendar(currentMonth);
        });
      });

      document.querySelectorAll('.next-month').forEach(button => {
        button.addEventListener('click', function() {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
          updateCalendar(currentMonth);
        });
      });

      // Handle modal close
      document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('dateModal').style.display = 'none';
      });

      // Close modal when clicking outside of it
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('dateModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      });

      // Handle form submission with EmailJS
      document.getElementById('generate-url').addEventListener('click', function(event) {
        event.preventDefault();
        const name = document.getElementById('name-select').value || document.getElementById('other-name-input').value;
        const comment = document.getElementById('comment-input').value;
        const email = document.getElementById('email-input').value;
        const preferredDates = Array.from(document.querySelectorAll('.preferred .date.bg-yellow-300')).map(el => el.getAttribute('data-date'));
        const notPreferredDates = Array.from(document.querySelectorAll('.not-preferred .date.bg-yellow-300')).map(el => el.getAttribute('data-date'));

        emailjs.send("service_id", "template_id", {
          "from_name": name,
          "message": comment,
          "preferred_dates": preferredDates.join(", "),
          "not_preferred_dates": notPreferredDates.join(", "),
          "reply_to": email,
        })
        .then(function(response) {
           console.log('SUCCESS!', response.status, response.text);
           alert("送信が完了しました");
        }, function(error) {
           console.log('FAILED...', error);
           alert("送信に失敗しました");
        });
      });
    });
  </script>
</body>
</html>
